require './editor.scss'

Viewer = require './viewer'

CommandHandler = require './commandhandler'
commandHandler = new CommandHandler()

Common = window.ObojoboDraft.Common
OBO = window.OBO

TextGroup = Common.textGroup.TextGroup
TextGroupEl = Common.chunk.textChunk.TextGroupEl
Chunk = Common.models.Chunk
TextChunk = Common.chunk.TextChunk
ChunkUtil = Common.chunk.util.ChunkUtil
SelectionHandler = Common.chunk.textChunk.TextGroupSelectionHandler
TextGroupSelection = Common.textGroup.TextGroupSelection

selectionHandler = new SelectionHandler()

Heading = React.createClass
	statics:
		type: 'ObojoboDraft.Chunks.Heading'
		register: ->
			OBO.registerChunk Heading
			OBO
				.registerToolbarItem
					id: 'headingSelector'
					type: 'select'
					label: 'Change text type'
					selectedOption: 'Heading 1'
					options: [
						'Heading 1',
						'Heading 2',
						'Normal Text'
					]
					onClick: (toolbarItem, editorState, selection) ->
						switch toolbarItem.selectedOption
							when 'Heading 1'
								newChunk = Chunk.create 'ObojoboDraft.Chunks.Heading'
								newChunk.modelState.headingLevel = 1
								newChunk.modelState.textGroup.first.text.styleText 'b'
								newChunk.modelState.textGroup.first.text.insertText 0, 'h1'
							when 'Heading 2'
								newChunk = Chunk.create 'ObojoboDraft.Chunks.Heading'
								newChunk.modelState.headingLevel = 2
							when 'Normal Text'
								newChunk = Chunk.create 'ObojoboDraft.Chunks.Text'

						ChunkUtil.replaceTextsWithinSelection editorState.selection, newChunk
						# newChunk.modelState.textGroup.first.text.styleText 'b'
						# newChunk.modelState.textGroup.__debug_print()

						# newChunk.selectAll selection
					onSelectionUpdate: (toolbarItem, editorState, selection) ->
						if selection.virtual?.start?.chunk?
							type = selection.startChunk.get('type')
							headingLevel = 0
							if type is 'ObojoboDraft.Chunks.Heading'
								headingLevel = selection.startChunk.modelState.headingLevel

							for chunk in selection.virtual.all
								if chunk.get('type') isnt type
									type = null
									break
								else if type is 'ObojoboDraft.Chunks.Heading' and chunk.modelState.headingLevel isnt headingLevel
									type = null
									break

							if type?
								switch type + headingLevel
									when 'ObojoboDraft.Chunks.Heading1'
										toolbarItem.selectedOption = 'Heading 1'
									when 'ObojoboDraft.Chunks.Heading2'
										toolbarItem.selectedOption = 'Heading 2'
									else
										toolbarItem.selectedOption = 'Normal Text'
							else
								toolbarItem.selectedOption = null
			OBO.registerTextListener {
				match: (selection, editor) ->
					console.clear()
					console.log('heading match')
					if selection.virtual.type is 'caret' and selection.startChunk.getComponent() is OBO.componentClassMap.defaultClass and selection.startChunk.modelState.textGroup?.first?
						chunk = selection.startChunk
						tgs = new TextGroupSelection chunk, selection.virtual
						st = tgs.start.textGroupItem.text.value

						if st is '# ' or st is '## '
							newChunk = Chunk.create Heading

							if st is '## '
								newChunk.modelState.headingLevel = 2

							chunk.addChildBefore newChunk

							tgs.selectText tgs.start.groupIndex

							newChunk.replaceSelection()
							newChunk.deleteSelection()

							editor.renderModule()
			}


		getSelectionHandler: -> selectionHandler
		getCommandHandler: -> commandHandler

		createNewNodeData: Viewer.createNewNodeData
		cloneNodeData: Viewer.cloneNodeData
		createNodeDataFromDescriptor: Viewer.createNodeDataFromDescriptor
		getDataDescriptor: Viewer.getDataDescriptor


	shouldComponentUpdate: ->
		@props.chunk.needsUpdate

	componentDidUpdate: ->
		@props.chunk.markUpdated()

	render: ->
		`<Viewer {...this.props} />`


Heading.register()

module.exports = Heading