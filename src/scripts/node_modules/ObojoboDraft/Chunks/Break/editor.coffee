Viewer = require './viewer'

Common = window.ObojoboDraft.Common
OBO = window.OBO

Chunk = Common.models.Chunk
FocusableSelectionHandler = Common.chunk.focusableChunk.FocusableSelectionHandler

selectionHandler = new FocusableSelectionHandler()


Break = React.createClass
	statics:
		type: 'ObojoboDraft.Chunks.Break'
		register: ->
			OBO.registerChunk Break, {
				insertItem:
					label: 'Break'
					icon: require 'svg-url?noquotes!./assets/insert-icon.svg'
					onInsert: (componentClass, position, referenceChunk, selection, callback) ->
						newChunk = Chunk.create componentClass
						focusChunk = null

						switch position
							when 'before'
								referenceChunk.addChildBefore newChunk

								if newChunk.isFirst()
									focusChunk = Chunk.create()
									newChunk.addChildBefore focusChunk
								else
									focusChunk = newChunk.prevSibling()

							when 'after'
								referenceChunk.addChildAfter newChunk

								if newChunk.isLast()
									focusChunk = Chunk.create()
									newChunk.addChildAfter focusChunk
								else
									focusChunk = newChunk.nextSibling()

						focusChunk.selectEnd()

						callback()
			}
			OBO.registerTextListener {
				match: (selection, editor) ->
					if selection.virtual.type is 'caret' and selection.startChunk.modelState.textGroup?.first?
						st = selection.startChunk.modelState.textGroup.first.text.value

						if st.indexOf("---") is 0 and st.length is 3
							chunk = selection.startChunk
							newChunk = Chunk.create Break
							chunk.replaceWith newChunk
							newChunk.markDirty()

							chunkAfter = Chunk.create()
							newChunk.addChildAfter chunkAfter

							chunkAfter.selectAll()

							editor.renderModule()
			}
		getCommandHandler: -> null
		getSelectionHandler: -> selectionHandler

		createNewNodeData: Viewer.createNewNodeData
		cloneNodeData: Viewer.cloneNodeData
		createNodeDataFromDescriptor: Viewer.createNodeDataFromDescriptor
		getDataDescriptor: Viewer.getDataDescriptor

	# shouldComponentUpdate: ->
	# 	@props.chunk.needsUpdate

	# componentDidUpdate: ->
	# 	@props.chunk.markUpdated()

	render: ->
		`<Viewer {...this.props} />`


Break.register()

module.exports = Break