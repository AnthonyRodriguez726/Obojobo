require './viewer-component.scss'

Common = window.ObojoboDraft.Common

OboComponent = Common.components.OboComponent

shuffle = require 'shuffle-array'

# @TODO - This wont update if new children are passed in via props

MCAssessment = React.createClass
	getDefaultProps: ->
		score: null
		type: 'practice'
		setScore: ->

	getInitialState: ->
		shuffledAnswers: @getShuffledAnswers(),
		selectedAnswers: new Set(),
		showAllFeedback: false

	# componentWillReceiveProps: (nextProps) ->
	# 	if nextProps.model?
	# 		@setState { shuffledAnswers:@getShuffledAnswers() }

	getShuffledAnswers: ->
		children = []
		for model in @props.model.children.models
			children.push model

		shuffle(children)

	onAnswerChoiceChange: (model, checked) ->
		submitAfter = false

		if @props.model.modelState.responseType isnt 'pick-all'
			@state.selectedAnswers.clear()
			submitAfter = true

		if checked
			@state.selectedAnswers.add model
		else
			@state.selectedAnswers.delete model

		@setState {
			selectedAnswers: @state.selectedAnswers,
			showAllFeedback: false
		}

		# @setState({ selectedId:model.get('id') })
		# @props.setScore model.modelState.score
		if submitAfter
			@sendScore()
		else
			@clearScore()



	calculateScore: ->
		# console.clear()
		# console.log @props.model.modelState.responseType

		if @props.model.modelState.responseType is 'pick-all'

			for mcChoice in @state.shuffledAnswers
				mcChoiceSelected = @state.selectedAnswers.has(mcChoice)
				isCorrectAnswer = mcChoice.modelState.score is 100
				isIncorrectAnswer = mcChoice.modelState.score is 0


				console.log 'calc', mcChoiceSelected, mcChoice.modelState.score

				if (isCorrectAnswer and not mcChoiceSelected) or (isIncorrectAnswer and mcChoiceSelected)
					return 0

			return 100
		else
			for mcChoice in @state.shuffledAnswers
				mcChoiceSelected = @state.selectedAnswers.has(mcChoice)
				isCorrectAnswer = mcChoice.modelState.score is 100
				isIncorrectAnswer = mcChoice.modelState.score is 0

				# console.log '-->', mcChoiceSelected, isCorrectAnswer, isIncorrectAnswer

				if mcChoiceSelected
					if isCorrectAnswer
						return 100
					return 0

		0

	onClickSubmit: (event) ->
		event.preventDefault()
		@setState({ showAllFeedback:true })
		@sendScore()

	onClickRevealAll: (event) ->
		event.preventDefault()
		@setState({ showAllFeedback:true })
		@clearScore()

	onClickReset: (event) ->
		event.preventDefault()
		@reset()

	reset: ->
		@state.selectedAnswers.clear()
		@setState {
			selectedAnswers: @state.selectedAnswers,
			showAllFeedback: false
		}

		@clearScore()

	sendScore: ->
		@props.setScore @calculateScore()

	clearScore: ->
		@props.setScore null

	render: ->
		responseType = @props.model.modelState.responseType

		instructions = switch responseType
			when 'pick-one' then 'Pick the correct answer'
			when 'pick-one-multiple-correct' then 'Pick a correct answer'
			when 'pick-all' then 'Pick all the correct answers'

		`<OboComponent
			model={this.props.model}
			tag="form"
			className={'obojobo-draft--chunks--mc-assessment' + (' is-response-type-' + this.props.model.modelState.responseType) + (this.state.showAllFeedback ? ' is-showing-all-feedback' : ' is-not-showing-all-feedback') + (this.props.score === null ? ' is-unscored' : ' is-scored')}
		>
			<span className="instructions pad">{instructions}:</span>
			{
				this.state.shuffledAnswers.map((function(child, index) {
					if(child.get('type') !== 'ObojoboDraft.Chunks.MCAssessment.MCChoice')
					{
						return null;
					}

					var isSelected = this.state.selectedAnswers.has(child)
					var Component = child.getComponentClass()
					return <Component
						key={child.get('id')}
						model={child}
						isSelected={isSelected}
						showFeedback={this.props.type === 'practice' && (this.state.showAllFeedback || (isSelected && responseType !== 'pick-all'))}
						type={this.props.type}
						onChange={this.onAnswerChoiceChange}
					/>
				}).bind(this))
			}
			{
				this.props.type === 'practice'
				?
				<div className="submit">
					{
						responseType === 'pick-all'
						?
						<button
							onClick={this.onClickSubmit}
							disabled={this.state.showAllFeedback}
						>
							Check Your Answers
						</button>
						:
						<button
							onClick={this.onClickRevealAll}
							disabled={this.state.showAllFeedback}
						>
							Reveal All Answers
						</button>
					}
					<span className="divider"> - </span>
					<button onClick={this.onClickReset}>Reset</button>
				</div>
				:
				<div className="submit" />
			}
		</OboComponent>`

module.exports = MCAssessment