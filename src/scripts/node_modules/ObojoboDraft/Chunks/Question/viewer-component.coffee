require './viewer-component.scss'

Common = window.ObojoboDraft.Common

OboComponent = Common.components.OboComponent
Dispatcher = Common.flux.Dispatcher

AssessmentUtil = window.Viewer.util.AssessmentUtil
ScoreUtil = window.Viewer.util.ScoreUtil
QuestionUtil = window.Viewer.util.QuestionUtil

Question = React.createClass
	getInitialState: ->
		if @props.model.modelState.type is 'assessment'
			currentAttempt = AssessmentUtil.getCurrentAttemptForModel @props.moduleData.assessmentState, @props.model

			if not currentAttempt.responses[@props.model.get('id')]?
				AssessmentUtil.registerQuestionForAttempt @props.model

		score: null
		# viewState: 'hidden' # hidden | active | viewed

	setScore: (score) ->
		ScoreUtil.setScore @props.model.get('id'), score

		@setState { score:score }

	onClickBlocker: ->
		QuestionUtil.viewQuestion @props.model.get('id')

	componentWillReceiveProps: (nextProps) ->
		if nextProps.model isnt @props.model
			@setScore null

		# currentViewState = QuestionUtil.getViewState @props.moduleData.questionState, @props.model
		# nextViewState    = QuestionUtil.getViewState nextProps.moduleData.questionState, @props.model

		# if currentViewState isnt nextViewState
		# 	@setState { viewState}

		# id = @props.model.get('id')
		# if nextProps.moduleData.scoreState.viewing is id
		# 	@setState { viewState:'active' }
		# else if nextProps.moduleData.scoreState.viewing isnt id
		# 	if not nextProps.moduleData.scoreState.viewed[id]
		# 		@setState { viewState:'hidden' }
		# 	else
		# 		@setState { viewState:'viewed' }

	render: ->
		if @props.model.modelState.type is 'practice'
			score = @state.score
		else
			score = null

		viewState = QuestionUtil.getViewState @props.moduleData.questionState, @props.model

		`<OboComponent
			model={this.props.model}
			className={'obojobo-draft--chunks--question' + (score === null ? '' : (score === 100 ? ' is-correct' : ' is-incorrect')) + (' is-type-' + this.props.model.modelState.type) + ' is-' + viewState}
		>
			{
				this.props.model.children.models.map((function(child, index) {
					var Component = child.getComponentClass()
					return <Component
						key={child.get('id')}
						model={child}
						setScore={this.setScore}
						score={score}
						type={this.props.model.modelState.type}
						moduleData={this.props.moduleData}
					/>
				}).bind(this))
			}
			<div className="blocker" onClick={this.onClickBlocker}>
				<span>Click to view question</span>
			</div>
		</OboComponent>`

module.exports = Question