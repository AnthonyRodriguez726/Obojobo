StyleableText = require 'ObojoboDraft/text/styleabletext'
TextGroup = require 'ObojoboDraft/text/textgroup'
TextGroupCommandHandler = require 'ObojoboDraft/text/textgroupcommandhandler'
Chunk = require 'ObojoboDraft/models/chunk'
Text = require 'ObojoboDraft/components/text'
TextChunk = require 'ObojoboDraft/components/textchunk'

SingleText = React.createClass
	statics:
		commandHandler: new TextGroupCommandHandler
		consumableElements: ['p']
		insertLabel: ['Text']
		onInsert: (position, referenceChunk, selection, opts, callback) ->
			newChunk = Chunk.create @

			switch position
				when 'before'
					referenceChunk.addBefore newChunk

				when 'after'
					referenceChunk.addAfter newChunk

			newChunk.selectStart selection

			callback()

		# OBONODE DATA METHODS
		# ================================================
		createNewNodeData: ->
			# console.log 'ST.createNewNodeData', data
			textGroup: TextGroup.create(1)
			indent: 0
			type: 'p'

		cloneNodeData: (data) ->
			# console.log 'ST.cloneNodeData', data
			textGroup: data.textGroup.clone()
			indent: data.indent
			type: data.type

		# SERIALIZATION/DECODE METHODS
		# ================================================
		createNodeDataFromDescriptor: (descriptor) ->
			# console.log 'ST.createNodeDataFromDescriptor', descriptor
			textGroup: TextGroup.fromDescriptor descriptor.content.textGroup, 1
			indent: descriptor.content.indent
			type: descriptor.content.type

		getDataDescriptor: (chunk) ->
			# console.log 'ST.getDataDescriptor', chunk
			data = chunk.componentContent

			indent: data.indent
			textGroup: data.textGroup.toDescriptor()
			type: data.type

		# HTML METHODS
		# ================================================
		createNewNodesFromElement: (el) ->
			group = TextGroup.create(1)
			group.first.text = StyleableText.createFromElement(el)

			[
				Chunk.create @, {
					textGroup: group
					indent: 0
					type: 'p'
				}
			]

	shouldComponentUpdate: ->
		@props.chunk.needsUpdate

	componentDidUpdate: ->
		@props.chunk.markUpdated()

	render: ->
		data = @props.chunk.componentContent

		`<TextChunk className="obojobo-draft--chunks--single-text pad" indent={data.indent}>
			<p>
				<Text text={data.textGroup.first.text} groupIndex="0" />
			</p>
		</TextChunk>`


module.exports = SingleText