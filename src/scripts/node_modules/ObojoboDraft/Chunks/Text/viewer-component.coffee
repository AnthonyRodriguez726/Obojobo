require './viewer-component.scss'

Common = window.ObojoboDraft.Common

OboComponent = Common.components.OboComponent
TextGroupEl = Common.chunk.textChunk.TextGroupEl
TextChunk = Common.chunk.TextChunk
Dispatcher = Common.flux.Dispatcher

varRegex = /\{\{(.+?)\}\}/

Text = React.createClass
	render: ->
		texts = @props.model.modelState.textGroup.items.map (textItem, index) =>
			if textItem.text.value.indexOf('{{')
				match = null
				textItem = textItem.clone()

				while (match = varRegex.exec(textItem.text.value)) isnt null
					variable = match[1]
					newText = window.OBO.getTextForVariable(variable, this.props.model, this.props.moduleData)
					if newText is null then newText = match[1]
					newText = '' + newText

					startIndex = textItem.text.value.indexOf(match[0], varRegex.lastIndex)
					textItem.text.replaceText(startIndex, startIndex + match[0].length, newText)

			`<TextGroupEl text={textItem.text} groupIndex={index} indent={textItem.data.indent} key={index} />`

		`<OboComponent model={this.props.model} moduleData={this.props.moduleData}>
			<TextChunk className="obojobo-draft--chunks--single-text pad">
				{texts}
			</TextChunk>
		</OboComponent>`


module.exports = Text