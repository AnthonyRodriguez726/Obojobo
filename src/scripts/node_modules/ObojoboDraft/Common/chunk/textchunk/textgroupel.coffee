emptyChar = require('ObojoboDraft/Common/text/textconstants').EMPTY_CHAR
DOMUtil = require 'ObojoboDraft/Common/page/domutil'
StyleableTextComponent = require 'ObojoboDraft/Common/text/styleabletextcomponent'

TextGroupEl = React.createClass
	statics:
		getTextElement: (chunk, groupIndex) ->
			chunk.getDomEl().querySelector("*[data-group-index='#{groupIndex}']")

		getTextElementAtCursor: (virtualCursor) ->
			TextGroupEl.getTextElement virtualCursor.chunk, virtualCursor.data.groupIndex

		getDomPosition: (virtualCursor) ->
			# console.log 'TGE.gDP', virtualCursor

			totalCharactersFromStart = 0

			element = TextGroupEl.getTextElementAtCursor virtualCursor

			# console.log 'element', element

			if not element then return null

			if element?
				# console.log 'tnodes', DOMUtil.getTextNodesInOrder(element), virtualCursor.data.offset
				for textNode in DOMUtil.getTextNodesInOrder(element)
					if totalCharactersFromStart + textNode.nodeValue.length >= virtualCursor.data.offset
						return { textNode:textNode, offset:virtualCursor.data.offset - totalCharactersFromStart }
					totalCharactersFromStart += textNode.nodeValue.length

			# There are no text nodes or something went really wrong, so return 0! ¯\_(ツ)_/¯
			return { textNode:null, offset:0 }

	componentDidUpdate: ->
		console.timeEnd 'textRender'

	render: ->
		console.time 'textRender'

		`<span className="text" data-group-index={this.props.groupIndex} data-indent={this.props.indent}>
			<StyleableTextComponent text={this.props.text} />
		</span>`

window.__gdp = TextGroupEl.getDomPosition

module.exports = TextGroupEl