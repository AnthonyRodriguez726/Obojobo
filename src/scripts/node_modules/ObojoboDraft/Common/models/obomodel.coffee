OBO = window.OBO
createUUID = require 'ObojoboDraft/Common/util/uuid'

DefaultAdapter =
	construct: (attrs) -> null
	clone: (clone) -> clone
	toJSON: (model, json) -> json


class OboModel extends Backbone.Model
	defaults: -> {
		id: null,
		content: {},
		metadata: {},
		index: 0,
		type: ''
	}

	constructor: (attrs, @adapter = DefaultAdapter) ->
		@parent = null
		@children = new OboModelCollection()

		@modelState = {
			dirty: false,
			needsUpdate: false,
			editing: false
		}

		if not attrs.id?
			attrs.id = @createNewLocalId()

		super(attrs)

		@adapter.construct(@, attrs)

		@children.on 'remove', @onChildRemove, @
		@children.on 'add', @onChildAdd, @
		@children.on 'reset', @onChildrenReset, @

	onChildRemove: (model, collection, options) ->
		model.parent = null
		model.markDirty()

	onChildAdd: (model, collection, options) ->
		model.parent = @
		model.markDirty()

	onChildrenReset: (collection, options) ->
		for child in @children.models
			child.parent = @

	createNewLocalId: ->
		createUUID()

	assignNewId: ->
		@set 'id', @createNewLocalId()

	# should be overridden
	clone: (deep = false) ->
		clone = new OboModel(@attributes, @adapter.constructor)
		@adapter.clone @, clone

		if deep and @hasChildren()
			for child in @children
				clone.children.add child.clone(true)

		clone

	toJSON: ->
		json = super()
		@adapter.toJSON(@, json)

		json.children = null

		if @hasChildren()
			json.children = []
			for child in @children.models
				json.children.push child.toJSON()

		json

	revert: ->
		# Does this work?
		newModel = new @constructor()

		index = @get 'index'
		id = @get 'id'

		@clear()

		for attrName, attr of newModel.attributes
			@set attrName, attr

		@set 'index', index
		@set 'id', id

		@modelState = newModel.modelState

		@

	markDirty: (markChildren = false) ->
		@modelState.dirty = @modelState.needsUpdate = true

		if markChildren
			for child in @children.models
				child.markDirty()

	markForUpdate: (markChildren = false) ->
		@modelState.needsUpdate = true

		if markChildren
			for child in @children.models
				child.markForUpdate()

	markUpdated: (markChildren = false) ->
		@modelState.needsUpdate = false

		if markChildren
			for child in @children.models
				child.modelState.needsUpdate = false

	getDomEl: ->
		# @TODO - This work?
		document.body.querySelector ".component[data-id='#{@get('id')}']"
		# document.body.querySelector ".component[data-component-index='#{@get('index')}']"

	getComponentClass: ->
		OBO.getItemForType(@get('type')).componentClass

	hasChildren: ->
		@children.models.length > 0

	isOrphan: ->
		not @parent?

	addChildBefore: (sibling) ->
		return if @isOrphan()

		collection = @parent.collection

		if collection.contains sibling
			collection.remove sibling

		collection.add sibling, { at:@get('index') }

	addChildAfter: (sibling) ->
		return if @isOrphan()

		collection = @parent.collection

		if collection.contains sibling
			collection.remove sibling

		collection.add sibling, { at:@get('index') + 1 }

	moveTo: (index) ->
		return if @get('index') is index

		refChunk = @parent.at index

		if index < @get('index')
			refChunk.addChildBefore @
		else
			refChunk.addChildAfter @

	moveToTop: ->
		@moveTo 0

	moveToBottom: ->
		@moveTo @parent.length - 1

	prevSibling: ->
		return null if @isOrphan() or @isFirst()
		@parent.at @get('index') - 1

	nextSibling: ->
		return null if @isOrphan() or @isLast()
		@parent.at @get('index') + 1

	isFirst: ->
		return false if @isOrphan()
		@get('index') is 0

	isLast: ->
		return false if @isOrphan()
		@get('index') is @parent.length - 1

	isBefore: (otherChunk) ->
		return false if @isOrphan()
		@get('index') < otherChunk.get('index')

	isAfter: (otherChunk) ->
		return false if @isOrphan()
		@get('index') > otherChunk.get('index')

	remove: ->
		if not @isOrphan() then @parent.remove @

	replaceWith: (newChunk) ->
		return if @isOrphan() or newChunk is @

		@addChildBefore newChunk
		@remove()

	__debug_print: (indent = '') ->
		console.log indent + @get('type')
		for child in @children.models
			child.__debug_print(indent + '  ')


class OboModelCollection extends Backbone.Collection
	# model: OboModel

# OboModel.create('chunk') = default chunk
# OboModel.create('ObojoboDraft.Chunks.List') = new list
# OboModel.create({type:'ObojoboDraft.Chunks.Table', content:{}, children:[]}) = new Table with children
OboModel.create = (typeOrNameOrJson, attrs = {}) ->
	console.log 'OboModel.create', typeOrNameOrJson, attrs

	# try json
	if typeof typeOrNameOrJson is 'object'
		oboModel = OboModel.create(typeOrNameOrJson.type, typeOrNameOrJson)

		if oboModel?
			children = typeOrNameOrJson.children
			if children?
				# delete typeOrNameOrJson.children

				for child in children
					c = OboModel.create(child)
					# console.log 'c be', c, oboModel.children
					oboModel.children.add c

		return oboModel

	item = OBO.getDefaultItemForModelType(typeOrNameOrJson)
	if not item
		item = OBO.getItemForType(typeOrNameOrJson)

	if not item
		console.log 'null', typeOrNameOrJson
		return null

	attrs.type = typeOrNameOrJson

	console.log 'creating', item.type, typeOrNameOrJson
	new OboModel(attrs, item.adapter)


module.exports = OboModel