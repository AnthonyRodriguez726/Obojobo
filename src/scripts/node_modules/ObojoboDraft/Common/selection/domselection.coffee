# Chrome sometimes has range startContainer / endContainer as an element node
# so we need to dig down in this case to find the first text node

DOMUtil = require 'ObojoboDraft/Common/page/domutil'

class DOMSelection
	constructor: ->
		@domSelection = window.getSelection()
		@domRange = null

		if @domSelection.rangeCount > 0
			@domRange = @domSelection.getRangeAt 0

	getType: ->
		if @domSelection.type?
			return @domSelection.type.toLowerCase()

		if @domSelection.isCollapsed?
			if @domSelection.isCollapsed
				return 'caret'
			else
				return 'range'

		if @domSelection.focusNode is @domSelection.anchorNode and @domSelection.focusOffset is @domSelection.anchorOffset
			return 'caret'

		'range'

	getClientRects: ->
		if not @domRange? then return []
		@domRange.getClientRects()

	set: (startNode, startOffset, endNode, endOffset) ->
		# console.log 'DS.set', startNode, startOffset, endNode, endOffset

		r = document.createRange()

		r.setStart startNode, startOffset
		r.setEnd endNode, endOffset

		@domSelection.removeAllRanges()
		@domSelection.addRange r

		@domRange = r

		@

	setStart: (node, offset) ->
		@domRange.setStart node, offset

	setEnd: (node, offset) ->
		@domRange.setEnd node, offset

	includes: (node) ->
		# console.log 'asking if', node, 'contains', @startText, 'and', @endText
		return false if not node?
		node.contains(@startText) and node.contains(@endText)


DOMSelection.set = (startNode, startOffset, endNode, endOffset) ->
	# console.log 'DS.set', startNode, startOffset, endNode, endOffset
	(new DOMSelection).set startNode, startOffset, endNode, endOffset

DOMSelection.includes = (node) ->
	(new DOMSelection).includes node

DOMSelection.get = ->
	new DOMSelection


Object.defineProperties DOMSelection.prototype, {
	startContainer:
		get: ->
			if not @domRange? then return null
			if @domRange.startContainer.nodeType is Node.TEXT_NODE then @domRange.startContainer.parentElement else @domRange.startContainer
	startText:
		get: ->
			if not @domRange? then return null
			DOMUtil.getFirstTextNodeOfElement @domRange.startContainer
	startOffset:
		get: ->
			if not @domRange? then return null
			@domRange.startOffset
	endContainer:
		get: ->
			if not @domRange? then return null
			if @domRange.endContainer.nodeType is Node.TEXT_NODE then @domRange.endContainer.parentElement else @domRange.endContainer
	endText:
		get: ->
			if not @domRange? then return null
			DOMUtil.getFirstTextNodeOfElement @domRange.endContainer
	endOffset:
		get: ->
			if not @domRange? then return null
			@domRange.endOffset
}

#@TODO
window.__ds = -> DOMSelection.get()


module.exports = DOMSelection