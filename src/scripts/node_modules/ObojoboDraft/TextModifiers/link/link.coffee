Keyboard = require('ObojoboDraft').page.Keyboard

regex = new RegExp(
	# "^" +
	# protocol identifier
	"(?:(?:https?)://)?" +
	# user:pass authentication
	"(?:\\S+(?::\\S*)?@)?" +
	"(?:" +
		# IP address exclusion
		# private & local networks
		"(?!(?:10|127)(?:\\.\\d{1,3}){3})" +
		"(?!(?:169\\.254|192\\.168)(?:\\.\\d{1,3}){2})" +
		"(?!172\\.(?:1[6-9]|2\\d|3[0-1])(?:\\.\\d{1,3}){2})" +
		# IP address dotted notation octets
		# excludes loopback network 0.0.0.0
		# excludes reserved space >= 224.0.0.0
		# excludes network & broacast addresses
		# (first & last IP address of each class)
		"(?:[1-9]\\d?|1\\d\\d|2[01]\\d|22[0-3])" +
		"(?:\\.(?:1?\\d{1,2}|2[0-4]\\d|25[0-5])){2}" +
		"(?:\\.(?:[1-9]\\d?|1\\d\\d|2[0-4]\\d|25[0-4]))" +
	"|" +
		# host name
		"(?:(?:[a-z\\u00a1-\\uffff0-9]-*)*[a-z\\u00a1-\\uffff0-9]+)" +
		# domain name
		"(?:\\.(?:[a-z\\u00a1-\\uffff0-9]-*)*[a-z\\u00a1-\\uffff0-9]+)*" +
		# TLD identifier
		"(?:\\.(?:[a-z\\u00a1-\\uffff]{2,}))" +
		# TLD may end with dot
		"\\.?" +
	")" +
	# port number
	"(?::\\d{2,5})?" +
	# resource path
	"(?:[/?#]\\S*)?" #+
	, "gi"
	# "$", "i"
)

Link =
	event: 'keydown'
	test: (event) ->
		event.keyCode is Keyboard.SPACE
	run: (selection) ->
		console.time 'linkify'

		links = []

		while (results = regex.exec(styleableText.value)) isnt null
			links.unshift [results.index, regex.lastIndex, styleableText.value.substring(results.index, regex.lastIndex)]

		for link in links
			if link[2].indexOf('http') isnt 0
				link[2] = 'http://' + link[2]
			styleableText.styleText 'a', link[0], link[1], { href:link[2] }

		console.timeEnd 'linkify'
