StyleableText = require 'ObojoboDraft/text/styleabletext'
StyleableTextRenderer = require './styleabletextrenderer'
emptyChar = require('ObojoboDraft/text/textconstants').EMPTY_CHAR
DOMUtil = require 'ObojoboDraft/page/domutil'

Text = React.createClass
	statics:
		getTextElement: (chunk, groupIndex) ->
			chunk.getDomEl().querySelector("*[data-group-index='#{groupIndex}']")

		getTextElementAtCursor: (virtualCursor) ->
			Text.getTextElement virtualCursor.chunk, virtualCursor.data.groupIndex

		getDomPosition: (virtualCursor) ->
			totalCharactersFromStart = 0

			element = Text.getTextElementAtCursor virtualCursor

			if not element then return null

			if element?
				for textNode in DOMUtil.getTextNodesInOrder(element)
					if totalCharactersFromStart + textNode.nodeValue.length >= virtualCursor.data.offset
						return { textNode:textNode, offset:virtualCursor.data.offset - totalCharactersFromStart }
					totalCharactersFromStart += textNode.nodeValue.length

			# There are no text nodes or something went really wrong, so return 0! ¯\_(ツ)_/¯
			return { textNode:null, offset:0 }

	componentDidUpdate: ->
		console.timeEnd 'textRender'

	createChild: (el, key) ->
		createChild = @createChild
		groupIndex = @props.groupIndex

		React.createElement el.type, { key:key.counter++ }, el.children.map( (child, index) ->
			switch child.nodeType
				when 'text'
					if child.text.length is 0
						`<span key={key.counter++}>{emptyChar}</span>`
					else if child.text.charAt(child.text.length - 1) is "\n"
						# Hack to force the display of a blank line that has no content
						`<span key={key.counter++}>{child.text}{emptyChar}</span>`
					else
						`<span key={key.counter++}>{child.text}</span>`
					# child.text || emptyChar
				else
					createChild(child, key)
		)

	render: ->
		console.time 'textRender'

		key = { counter:0 }
		mockElement = StyleableTextRenderer @props.text
		`<span className="text" data-group-index={this.props.groupIndex} data-indent={this.props.indent}>
			{this.createChild(mockElement, key)}
		</span>`

window.__gdp = Text.getDomPosition

module.exports = Text