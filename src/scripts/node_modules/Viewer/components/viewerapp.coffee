require './viewerapp.scss'

InlineNavButton = require 'Viewer/components/inlinenavbutton'
NavUtil = require 'Viewer/util/navutil'
Logo = require 'Viewer/components/logo'

OBO = window.OBO
Common = window.ObojoboDraft.Common
Legacy = Common.models.Legacy

OboModel = Common.models.OboModel

Nav = require './nav'

ReactDOM = window.ReactDOM
Dispatcher = Common.flux.Dispatcher
ModalContainer = Common.components.ModalContainer
SimpleDialog = Common.components.modal.SimpleDialog
ModalUtil = Common.util.ModalUtil

Dispatcher.on 'all', (eventName, payload) -> console.log 'EVENT TRIGGERED', eventName

Dispatcher.on 'viewer:alert', (payload) ->
	ModalUtil.show `<SimpleDialog ok title={payload.value.title}>{payload.value.message}</SimpleDialog>`

ViewerApp = React.createClass

	# === REACT LIFECYCLE METHODS ===

	getInitialState: ->
		OBO.loadDependency 'https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css'

		Dispatcher.on 'viewer:scrollTo', (payload) ->
			ReactDOM.findDOMNode(@refs.container).scrollTop = payload.value

		navTargetIndex: @props.moduleData.navState.navTargetIndex

	componentWillReceiveProps: (nextProps) ->
		navTargetIndex = @props.moduleData.navState.navTargetIndex
		nextNavTargetIndex = nextProps.moduleData.navState.navTargetIndex

		if @state.navTargetIndex isnt nextNavTargetIndex
			# alert 'needs scroll'
			@needsScroll = true
			@setState { navTargetIndex:nextNavTargetIndex }

	componentDidUpdate: ->
		# alert 'here, fixme'
		if @lastCanNavigate isnt NavUtil.canNavigate(@props.moduleData.navState)
			@needsScroll = true
		@lastCanNavigate = NavUtil.canNavigate(@props.moduleData.navState)
		if @needsScroll?
			el = ReactDOM.findDOMNode(@refs.prev)
			if el
				ReactDOM.findDOMNode(@refs.container).scrollTop = ReactDOM.findDOMNode(el).getBoundingClientRect().height
			else
				ReactDOM.findDOMNode(@refs.container).scrollTop = 0

			delete @needsScroll

	# === NON REACT LIFECYCLE METHODS ===

	update: (json) ->
		try
			o = JSON.parse(json)
		catch e
			alert 'Error parsing JSON'
			@setState { model:@state.model }
			return

	onBack: ->
		NavUtil.goPrev()

	onNext: ->
		NavUtil.goNext()

	# === RENDER METHODS ===

	render: ->
		window.__lo = @props.moduleData.model

		ModuleComponent = @props.moduleData.model.getComponentClass()

		console.log @props

		navTargetModel = NavUtil.getNavTargetModel @props.moduleData.navState
		navTargetTitle = '?'
		if(navTargetModel?)
			navTargetTitle = navTargetModel.title

		prevNav = nextNav = null
		if NavUtil.canNavigate(@props.moduleData.navState)

			prevNav = NavUtil.getPrev @props.moduleData.navState
			if prevNav
				prevEl = `<InlineNavButton ref="prev" type="prev" title={OboModel.models[prevNav.id].title} />`
			else
				prevEl = `<InlineNavButton ref="prev" type="prev" title="Start of content" disabled />`

			nextNav = NavUtil.getNext @props.moduleData.navState
			if nextNav
				nextEl = `<InlineNavButton ref="next" type="next" title={OboModel.models[nextNav.id].title} />`
			else
				nextEl = `<InlineNavButton ref="next" type="next" title="End of content" disabled />`

		modal = ModalUtil.getCurrentModal @props.moduleData.modalState

		`<div ref="container" className={'viewer--viewer-app' + (this.props.moduleData.navState.locked ? ' is-locked-nav' : ' is-unlocked-nav') + (this.props.moduleData.navState.open ? ' is-open-nav' : ' is-closed-nav') + (this.props.moduleData.navState.disabled ? ' is-disabled-nav' : ' is-enabled-nav')}>
			<header>
				<div className="pad">
					<span className="module-title">{this.props.moduleData.model.title}</span>
					<span className="location">{navTargetTitle}</span>
					<Logo />
				</div>
			</header>
			<Nav navState={this.props.moduleData.navState} />
			{prevEl}
			<ModuleComponent model={this.props.moduleData.model} moduleData={this.props.moduleData} />
			{nextEl}
			{
				modal
				?
				<ModalContainer>
					{modal}
				</ModalContainer>
				:
				null
			}
		</div>`

module.exports = ViewerApp
