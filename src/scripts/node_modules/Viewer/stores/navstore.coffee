OBO = window.OBO
Store = window.ObojoboDraft.Common.flux.Store
Dispatcher = window.ObojoboDraft.Common.flux.Dispatcher

generateNav = (model) ->
	nav = []
	item = OBO.getItemForType(model.get('type'))
	if item.generateNav?
		nav = nav.concat item.generateNav(model)

	for child in model.children.models
		nav = nav.concat generateNav(child)

	nav

getNavTargetByModel = (model) ->
	for item in state.items
		if item.value is model then return item

	null

state = {
	items: []
	navTarget: null
	locked: false
	open: true
}

NavStore = Object.assign(new Store(),
	init: (model) ->
		state.items = generateNav model
		state.navTarget = state.items[0]

	getState: -> state

	canNavigate: ->
		not state.locked and not state.disabled

	getPrev: ->
		index = state.items.indexOf state.navTarget

		return null if index is -1

		while true
			index--
			item = state.items[index]

			break if not item?

			if item.type is 'link'
				return state.items[index]

		null

	getNext: ->
		index = state.items.indexOf state.navTarget

		return null if index is -1

		while true
			index++
			item = state.items[index]

			break if not item?

			if item.type is 'link'
				return state.items[index]

		null
)

NavStore.dispatchToken = Dispatcher.register (payload) ->
	switch payload.type
		when 'navPrev'
			return false if not NavStore.canNavigate()
			state.navTarget = NavStore.getPrev()

		when 'navNext'
			return false if not NavStore.canNavigate()
			state.navTarget = NavStore.getNext()

		when 'navGoto'
			return false if not NavStore.canNavigate()
			state.navTarget = getNavTargetByModel(payload.value)

		when 'navLock'
			state.locked = true

		when 'navUnlock'
			state.locked = false

		when 'navClose'
			state.open = false

		when 'navOpen'
			state.open = true

		when 'navDisable'
			state.disabled = true
			state.open = false

		when 'navEnable'
			state.disabled = false

		when 'navToggle'
			state.open = not state.open

	console.log 'NOW STATE IS', state, NavStore.emitChange

	NavStore.emitChange()


module.exports = NavStore