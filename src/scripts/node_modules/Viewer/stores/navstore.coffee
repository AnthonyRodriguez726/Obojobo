OBO = window.OBO
Store = window.ObojoboDraft.Common.flux.Store
Dispatcher = window.ObojoboDraft.Common.flux.Dispatcher
OboModel = window.ObojoboDraft.Common.models.OboModel


OBO.triggerActions.navDisable = (model, action) ->
	setTimeout ->
		Dispatcher.dispatch {
			type: 'navDisable'
		}

OBO.triggerActions.navEnable = (model, action) ->
	setTimeout ->
		Dispatcher.dispatch {
			type: 'navEnable'
		}

OBO.triggerActions.navLock = (model, action) ->
	setTimeout ->
		Dispatcher.dispatch {
			type: 'navLock'
		}

OBO.triggerActions.navUnlock = (model, action) ->
	setTimeout ->
		Dispatcher.dispatch {
			type: 'navUnlock'
		}

OBO.triggerActions.navOpen = (model, action) ->
	setTimeout ->
		Dispatcher.dispatch {
			type: 'navOpen'
		}

OBO.triggerActions.navClose = (model, action) ->
	setTimeout ->
		Dispatcher.dispatch {
			type: 'navClose'
		}

OBO.triggerActions.navGoto = (model, action) ->
	setTimeout ->
		Dispatcher.dispatch {
			type: 'navGoto',
			value: OboModel.models[action.value]
		}



generateNav = (model) ->
	nav = []
	item = OBO.getItemForType(model.get('type'))
	if item.generateNav?
		nav = nav.concat item.generateNav(model)

	for child in model.children.models
		nav = nav.concat generateNav(child)

	nav

getNavTargetByModel = (model) ->
	for item in state.items
		if item.value is model then return item

	null

goto = (newNavTarget) ->
	if state.navTarget
		state.navTarget.value.processTrigger 'onNavExit'

	state.navTarget = newNavTarget

	state.navTarget.value.processTrigger 'onNavEnter'

state = {
	items: []
	navTarget: null
	locked: false
	open: false
}

NavStore = Object.assign(new Store(),
	init: (model) ->
		state.items = generateNav model
		goto state.items[0]

	getState: -> state

	canNavigate: ->
		not state.locked and not state.disabled

	getPrev: ->
		index = state.items.indexOf state.navTarget

		return null if index is -1

		while true
			index--
			item = state.items[index]

			break if not item?

			if item.type is 'link'
				return state.items[index]

		null

	getNext: ->
		index = state.items.indexOf state.navTarget

		return null if index is -1

		while true
			index++
			item = state.items[index]

			break if not item?

			if item.type is 'link'
				return state.items[index]

		null
)

NavStore.dispatchToken = Dispatcher.register (payload) ->
	switch payload.type
		when 'navPrev'
			goto NavStore.getPrev()

		when 'navNext'
			goto NavStore.getNext()

		when 'navGoto'
			goto getNavTargetByModel(payload.value)

		when 'navLock'
			state.locked = true

		when 'navUnlock'
			state.locked = false

		when 'navClose'
			state.open = false

		when 'navOpen'
			state.open = true

		when 'navDisable'
			state.disabled = true
			state.open = false

		when 'navEnable'
			state.disabled = false

		when 'navToggle'
			state.open = not state.open

	NavStore.emitChange()


module.exports = NavStore