NavUtil = require 'Viewer/util/navutil'

OBO = window.OBO
Store = window.ObojoboDraft.Common.flux.Store
Dispatcher = window.ObojoboDraft.Common.flux.Dispatcher
OboModel = window.ObojoboDraft.Common.models.OboModel

class NavStore extends Store
	constructor: ->
		super('navstore')

		@state = {
			items: []
			navTargetIndex: -1
			locked: false
			open: true
		}

	init: (model, startingId) ->
		Dispatcher.on
			'nav:prev':    (payload) => @gotoIndex NavUtil.getPrevIndex(@state)
			'nav:next':    (payload) => @gotoIndex NavUtil.getNextIndex(@state)
			'nav:goto':    (payload) => @gotoIndex NavUtil.getIndexById(@state, payload.value.id)
			'nav:lock':    (payload) => @setAndTrigger({locked: true})
			'nav:unlock':  (payload) => @setAndTrigger({locked: false})
			'nav:close':   (payload) => @setAndTrigger({open: false})
			'nav:open':    (payload) => @setAndTrigger({open: true})
			'nav:disable': (payload) => @setAndTrigger({disabled: true, locked: true, open: false})
			'nav:enable':  (payload) => @setAndTrigger({disabled: false, locked: false})
			'nav:toggle':  (payload) => @setAndTrigger({open: !@state.open})
			'nav:openExternalLink': (payload) =>
				window.open(payload.value.url)
				@triggerChange()
			# 'nav:addNavItems': (payload) =>
			# 	@state.items = @state.items.concat payload.value.items
			# 	@triggerChange()

		@state.items = @generateNav model

		if startingId?
			@gotoIndex NavUtil.getIndexById(@state, startingId)
		else
			@gotoIndex NavUtil.getNextIndex(@state)


	getState: -> @state

	setState: (newState) -> @state = newState

	gotoIndex: (newNavTargetIndex) ->
		navTargetModel = NavUtil.getNavTargetModel(@state)?.processTrigger 'onNavExit'
		@state.navTargetIndex = newNavTargetIndex
		NavUtil.getNavTargetModel(@state).processTrigger 'onNavEnter'
		@triggerChange()

	generateNav: (model) ->
		nav = []
		item = OBO.getItemForType(model.get('type'))
		if item.generateNav?
			nav = nav.concat item.generateNav(model)

		for child in model.children.models
			nav = nav.concat @generateNav(child)

		nav

navStore = new NavStore()
window.__ns = navStore
module.exports = navStore
