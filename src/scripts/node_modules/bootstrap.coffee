"use strict";

ObojoboDraft = require 'ObojoboDraft'
API = require 'net/api'

Chunks = require '../../../chunks.coffee'
Chunks['ObojoboDraft.Chunks.SingleText'] = require 'ObojoboDraft/Chunks/SingleText/editor'
Chunks['ObojoboDraft.Chunks.Error'] = require 'ObojoboDraft/Chunks/Error/editor'

loadChunk = ObojoboDraft.loadChunk
ComponentClassMap = ObojoboDraft.util.ComponentClassMap
Head = ObojoboDraft.page.Head
Module = ObojoboDraft.models.Module

load = (loadCallback) ->
	id = decodeURIComponent(document.location.hash).substr(1)

	if id.indexOf('json:') is 0
		lo = JSON.parse id.substr(5)
		loadCallback Module.createFromDescriptor(lo)
	else if id isnt ''
		API.module.get id, loadCallback
	else
		loadCallback()


module.exports = (loadCallback) ->
	# dynamically load all the chunks we need
	dependenciesPromises = []

	# require.ensure [], (require) ->
	for chunkName, componentClass of Chunks
		ComponentClassMap.register chunkName, componentClass

		if componentClass.dependencies?
			dependenciesPromises.push componentClass.dependencies

	ComponentClassMap.setDefault 'ObojoboDraft.Chunks.SingleText'
	ComponentClassMap.setError 'ObojoboDraft.Chunks.Error'

	if dependenciesPromises.length > 0
		#@TODO - not supported in IE
		Promise.all(dependenciesPromises).then(
			(values) -> load loadCallback
		)
		.catch(
			(reason) ->
				console.log reason
				#@TODO - do something
		)
	else
		load loadCallback



