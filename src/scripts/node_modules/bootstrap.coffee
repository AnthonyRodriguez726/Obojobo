"use strict";

ObojoboDraft = require 'ObojoboDraft'
API = require 'net/api'

loadChunk = ObojoboDraft.loadChunk
ComponentClassMap = ObojoboDraft.util.ComponentClassMap
Head = ObojoboDraft.page.Head

chunks = require "json!../../../chunk-config.json"
chunks.push 'ObojoboDraft.Chunks.SingleText'

load = (loadCallback) ->
	id = document.location.hash.substr(1)
	if id isnt ''
		API.module.get id, loadCallback
	else
		loadCallback()


module.exports = (loadCallback) ->
	# dynamically load all the chunks we need
	dependenciesPromises = []

	require.ensure [], (require) ->
		for chunk in chunks
			componentClass = require './' + chunk.replace(/\./g, '/') + '/editor'
			ComponentClassMap.register chunk, componentClass

			if componentClass.dependencies?
				dependenciesPromises.push componentClass.dependencies
				# componentClass.dependenciesLoaded = false
				# Head.add componentClass.dependencies[0], ((cc) ->
				# 	cc.dependenciesLoaded = false
				# ).bind(@, componentClass)

		ComponentClassMap.setDefault 'ObojoboDraft.Chunks.SingleText'

		if dependenciesPromises.length > 0
			#@TODO - not supported in IE
			Promise.all(dependenciesPromises).then(
				(values) -> load loadCallback
			)
			.catch(
				(reason) ->
					console.log reason
					#@TODO - do something
			)
		else
			load loadCallback



