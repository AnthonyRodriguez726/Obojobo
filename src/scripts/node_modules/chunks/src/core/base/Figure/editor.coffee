require './editor.scss'
require './viewer.scss'

ObojoboDraft = window.ObojoboDraft
OBO = window.OBO

TextCommandHandler = require './commandhandler'
SelectionHandler = require './selectionhandler'
Image = require './image'

TextGroup = ObojoboDraft.textGroup.TextGroup
TextGroupEl = ObojoboDraft.chunk.textChunk.TextGroupEl
Anchor = ObojoboDraft.components.Anchor
Chunk = ObojoboDraft.models.Chunk
DOMSelection = ObojoboDraft.selection.DOMSelection
Keyboard = ObojoboDraft.page.Keyboard
FocusableChunk = ObojoboDraft.chunk.FocusableChunk
SingleInputBubble = ObojoboDraft.components.modal.bubble.SingleInputBubble
ChunkUtil = ObojoboDraft.chunk.util.ChunkUtil
TextGroupSelection = ObojoboDraft.textGroup.TextGroupSelection
TextGroupSelectionHandler = ObojoboDraft.chunk.textChunk.TextGroupSelectionHandler

# ToggleCommandHandler = Editor.chunk.focusableChunk.ToggleCommandHandler

# commandHandler = new ToggleCommandHandler(new TextCommandHandler())
commandHandler = new TextCommandHandler()
selectionHandler = new SelectionHandler()

sizes = ['small', 'medium', 'large']



Figure = React.createClass
	statics:
		type: 'ObojoboDraft.Chunks.Figure'
		register: ->
			OBO.registerChunk Figure, {
				insertItem:
					label: 'Figure'
					icon: require 'svg-url?noquotes!./assets/insert-icon.svg'
					onInsert: ObojoboDraft.chunk.util.InsertWithText
			}
			OBO.addToolbarItem {
				type: 'button'
				label: 'Figure'
				icon: require 'svg-url?noquotes!./assets/toolbar-icon.svg'
				onClick: (toolbarItem, editorState) ->
					newChunk = Chunk.create Figure

					console.log 'BEFORE'
					__lo.__print()

					editorState.selection.startChunk.addChunkBefore newChunk
					newChunk.replaceSelection()
					newChunk.selectStart()

					console.log 'AFTER'
					__lo.__print()
			}

		getCommandHandler: -> commandHandler
		getSelectionHandler: -> selectionHandler

		# OBONODE DATA METHODS
		# ================================================
		createNewNodeData: ->
			tg = TextGroup.create(1)
			tg.first.text.styleText 'i'

			textGroup: tg
			url: null #'http://lorempixel.com/1024/760/'
			size: 'small'

		cloneNodeData: (data) ->
			textGroup: data.textGroup.clone()
			url: data.url
			size: data.size

		# SERIALIZATION/DECODE METHODS
		# ================================================
		createNodeDataFromDescriptor: (descriptor) ->
			textGroup: TextGroup.fromDescriptor descriptor.content.textGroup, 1
			url: descriptor.content.url
			size: descriptor.content.size

		getDataDescriptor: (chunk) ->
			data = chunk.componentContent

			textGroup: data.textGroup.toDescriptor()
			url: data.url
			size: data.size

	setSize: (size) ->
		@props.chunk.markDirty()

		data = @props.chunk.componentContent
		data.size = size

		@props.saveAndRenderModuleFn()

	nextSize: (event) ->
		event.preventDefault()

		data = @props.chunk.componentContent
		@setSize sizes[(sizes.indexOf(data.size) + 1) % sizes.length]

	onAnchorKeyDown: (event) ->
		@props.onKeyDownPutChunkOnClipboard event, @props.chunk

		switch event.keyCode
			when Keyboard.DELETE, Keyboard.BACKSPACE
				event.preventDefault()

				newChunk = Chunk.create @
				@props.chunk.replaceWith newChunk

				newChunk.selectEnd @props.selection

	setImageURL: ->
		@props.chunk.markDirty()
		@props.editChunk @props.chunk

	onChange: (newValue) ->
		@props.chunk.markDirty()
		console.log 'YT on Change', newValue
		# @props.chunk.markDirty()
		# data = @props.chunk.componentContent
		# data.videoId = newValue
		@setState { userImageURL:newValue }

	onClose: ->
		@props.chunk.markDirty()
		@props.chunk.componentContent.url = @state.userImageURL

		@setState {
			chunk: @props.chunk
		}

		# @props.setTextMode on
		@props.stopEditing()

		@props.selection.virtual.setCaret @props.chunk.get('index'), { groupIndex:'anchor:main', offset:0 }
		@props.saveAndRenderModuleFn()

	# shouldComponentUpdate: ->
	# 	@props.chunk.needsUpdate

	componentDidUpdate: ->
		@props.chunk.markUpdated()

	render: ->
		data = @props.chunk.componentContent

		focus = 'none'
		pos = @props.selectionState
		if pos is 'contains' or pos is 'start' or pos is 'inside' or pos is 'end'
			focus = switch @props.selection.virtual.start.data.groupIndex
				when 'anchor:main' then 'anchor'
				else 'caption'

		`<FocusableChunk
			className={'obojobo-draft--chunks--figure editor ' + data.size}
			ref="component"
			onKeyDown={this.onAnchorKeyDown}
			shouldPreventTab={this.props.shouldPreventTab}
		>
			<figure
				className={(data.textGroup.first.text.length === 0 && focus !== 'caption' ? 'empty-caption' : '') + ' focus-' + focus}
				unselectable="on"
			>
				<div className={'container highlight-on-hover' + (focus === 'anchor' ? ' outline-on-selection' : '')} ref="container">
					<Image chunk={this.props.chunk} />

					<div className="size-controls">
						<button onMouseDown={this.nextSize}>Size</button>
					</div>
					<div className="img-controls">
						<button onMouseDown={this.setImageURL}>Set image from URL</button>
						<button onMouseDown={this.todo}>Upload image</button>
					</div>
				</div>
				<figcaption
					className="pad"
					contentEditable="true"
					suppressContentEditableWarning={true}
					ref="caption"
					tabIndex={this.props.shouldPreventTab ? '-1' : ''}
				>
					<TextGroupEl text={data.textGroup.first.text} groupIndex="0" />
				</figcaption>
			</figure>
			{
				this.props.isEditing
				?
				<SingleInputBubble
					label="Image URL"
					value={this.state.userImageURL}
					onChange={this.onChange}
					onClose={this.onClose}
					onCancel={this.onCancel}
				/>
				:
				null
			}
		</FocusableChunk>`



module.exports = Figure