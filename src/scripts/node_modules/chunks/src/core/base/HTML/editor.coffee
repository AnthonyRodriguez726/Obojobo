require './editor.scss'

Viewer = require './viewer'

ObojoboDraft = window.ObojoboDraft
OBO = window.OBO
Editor = window.Editor

FocusableCommandHandler = Editor.chunk.focusableChunk.FocusableCommandHandler
Chunk = ObojoboDraft.models.Chunk
FocusableChunk = ObojoboDraft.chunk.FocusableChunk
SingleInputBubble = ObojoboDraft.components.modal.bubble.SingleInputBubble
Keyboard = ObojoboDraft.page.Keyboard
DeleteButton = ObojoboDraft.components.DeleteButton
EditButton = ObojoboDraft.components.EditButton
FocusableSelectionHandler = ObojoboDraft.chunk.focusableChunk.FocusableSelectionHandler

commandHandler = new FocusableCommandHandler()
selectionHandler = new FocusableSelectionHandler()

HTML = React.createClass
	statics:
		type: 'ObojoboDraft.Chunks.HTML'
		register: ->
			OBO.registerChunk HTML, {
				insertItem:
					label: 'HTML'
					icon: require 'svg-url?noquotes!./assets/insert-icon.svg'
					onInsert: ObojoboDraft.chunk.util.Insert
			}
		label: 'HTML Video'
		getCommandHandler: -> commandHandler
		getSelectionHandler: -> selectionHandler

		createNewNodeData: Viewer.createNewNodeData
		cloneNodeData: Viewer.cloneNodeData
		createNodeDataFromDescriptor: Viewer.createNodeDataFromDescriptor
		getDataDescriptor: Viewer.getDataDescriptor


	getInitialState: ->
		userHTML: @props.chunk.componentContent.html

	startEditing: ->
		@props.editChunk @props.chunk

	onChange: (event) ->
		@props.chunk.markDirty()
		@props.chunk.componentContent.html = event.target.value

		@setState {
			userHTML: event.target.value
		}

	# onClose: ->
	# 	@props.chunk.markDirty()
	# 	@props.chunk.componentContent.html = @state.userHTML

	# 	# @props.setTextMode on
	# 	@props.stopEditing()

	# 	@props.selection.virtual.setCaret @props.chunk.get('index'), { groupIndex:'anchor:main', offset:0 }
	# 	@props.saveAndRenderModuleFn()

	delete: ->
		chunk = @props.chunk
		chunk.revert()

		@props.saveAndRenderModuleFn()

	onAnchorKeyDown: (event) ->
		@props.onKeyDownPutChunkOnClipboard event, @props.chunk

		switch event.keyCode
			when Keyboard.ENTER
				event.preventDefault()
				@startEditing()
				return

	# shouldComponentUpdate: ->
	# 	@props.chunk.needsUpdate

	componentDidUpdate: ->
		@props.chunk.markUpdated()

	render: ->
		data = @props.chunk.componentContent

		contents = switch
			when @props.isEditing
				`<textarea value={this.state.userHTML} onChange={this.onChange} />`
			when data.html
				`<Viewer {...this.props} />`
			else
				`<div className="placeholder">Double click here to specify a HTML video</div>`

		`<FocusableChunk onDoubleClick={this.startEditing} onKeyDown={this.onAnchorKeyDown} className={'obojobo-draft--chunks--html pad editor' + (this.props.isEditing ? ' focus' : '')} shouldPreventTab={this.props.shouldPreventTab}>
			<div className="container outline-on-selection highlight-on-hover">
				{ !this.props.isEditing ? <DeleteButton onClick={this.delete} shouldPreventTab={this.props.shouldPreventTab} /> : null }
				{ !this.props.isEditing ? <EditButton onClick={this.startEditing} /> : null }
				{contents}
			</div>
		</FocusableChunk>`


module.exports = HTML