require './sidemenu.scss'

SideMenuList = require './sidemenu/sidemenulist'
SideMenuHandle = require './sidemenu/sidemenuhandle'

dragula = require 'Dragula'

ObojoboDraft = require 'ObojoboDraft'
DOMUtil = ObojoboDraft.page.DOMUtil

MARGIN = 15
WIDTH = 30
HEIGHT = 30

SideMenu = React.createClass
	getInitialState: ->
		chunkRect: @props.selection.chunkRect
		draggedNode: null

	componentWillReceiveProps: (nextProps) ->
		@setState {
			chunkRect: nextProps.selection.chunkRect
		}

	onBeforeClick: (componentClass) ->
		@props.handlerFn 'before', componentClass

	onAfterClick: (componentClass) ->
		@props.handlerFn 'after', componentClass

	setupDragAndDrop: ->
		if @dragAndDropReady then return

		if @drake then @drake.destroy()

		thisEl = ReactDOM.findDOMNode(@)

		@drake = dragula [@props.controlsEl],
			moves: (el) -> el is thisEl

		@drake.on 'drag', @onDrag
		@drake.on 'dragend', @onDragEnd

		@dragAndDropReady = true

	onDrag: (el) ->
		@props.onStartDrag()

		draggedContainer = document.createElement 'div'
		draggedContainer.style.width = @state.chunkRect.width + 'px'
		draggedContainer.style.height = @state.chunkRect.height + 'px'

		for chunk in @props.selection.chunk.all
			chunkEl = chunk.getDomEl()
			chunkEl.classList.add 'dragged'

			chunkCloneEl = chunkEl.cloneNode true
			chunkCloneEl.setAttribute 'data-id', '0'
			draggedContainer.appendChild chunkCloneEl

		document.addEventListener 'mousemove', @boundMouseMoveListener

		@setState {
			draggedNode: draggedContainer
		}

		true

	onMouseMove: (event) ->
		if not @lastClientY then @lastClientY = event.clientY

		if event.clientY > @lastClientY
			@direction = 'down'
		else if event.clientY < @lastClientY
			@direction = 'up'

		startChunk = @props.selection.chunk.start.chunk
		selChunk = startChunk.getDomEl()

		el = document.elementFromPoint(window.innerWidth / 2, event.clientY)

		mouseChunkIndex = DOMUtil.findParentAttr(el, 'data-component-index')

		console.clear()
		console.log mouseChunkIndex

		return if not mouseChunkIndex?

		mouseChunk = @props.module.chunks.at parseInt(mouseChunkIndex, 10)
		mouseChunkEl = mouseChunk.getDomEl()

		if not mouseChunkEl.classList.contains 'dragged'
			@dragNewIndex = mouseChunk.get('index')
			# console.clear()
			# console.log mouseChunk.get('id'), @dragNewIndex
			switch @direction
				when 'up'
					mouseChunkEl.parentElement.insertBefore selChunk, mouseChunkEl

					for chunk in @props.selection.chunk.all.slice(1).reverse()
						mouseChunkEl.parentElement.insertBefore chunk.getDomEl(), selChunk.nextSibling
				when 'down'
					mouseChunkEl.parentElement.insertBefore selChunk, mouseChunkEl.nextSibling

					for chunk in @props.selection.chunk.all.slice(1).reverse()
						mouseChunkEl.parentElement.insertBefore chunk.getDomEl(), selChunk.nextSibling


		@lastClientY = event.clientY

		true

	onDragEnd: ->
		document.removeEventListener 'mousemove', @boundMouseMoveListener

		oldIndex = @props.selection.chunk.start.chunk.get('index')
		if oldIndex > @dragNewIndex
			for chunk in @props.selection.chunk.all.reverse()
				@props.module.moveChunk chunk, @dragNewIndex
		else if oldIndex < @dragNewIndex
			for chunk in @props.selection.chunk.all
				@props.module.moveChunk chunk, @dragNewIndex

		@props.onDrop chunk

		@setState {
			draggedNode: null
		}

	componentDidMount: ->
		@boundMouseMoveListener = @onMouseMove.bind(@)

	render: ->
		chunkRect = @state.chunkRect

		if not chunkRect or not @props.controlsEl then return null

		ctrlRect = @props.controlsEl.getBoundingClientRect()

		top = chunkRect.top - ctrlRect.top - MARGIN
		bottom = chunkRect.bottom - ctrlRect.top - MARGIN

		styles =
			top: top

		`<div className={'editor--components--side-menu' + (this.state.draggedNode ? ' dragging' : '')} style={styles} onMouseOver={this.setupDragAndDrop}>
			<SideMenuHandle yPos={HEIGHT / 2} height={bottom - top} />
			<SideMenuList inserts={this.props.inserts} onMouseDown={this.onBeforeClick} yPos={0} />
			<SideMenuList inserts={this.props.inserts} onMouseDown={this.onAfterClick} yPos={bottom - top} />
			{
				this.state.draggedNode
				?
				<div className="clone-container" ref="cloneContainer" dangerouslySetInnerHTML={{ __html:this.state.draggedNode.outerHTML }}></div>
				:
				null
			}
		</div>`


module.exports = SideMenu